<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix - Painel de Gestão</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --sidebar-width: 250px;
        }
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 1000;
            width: var(--sidebar-width);
            padding: 56px 0 0; 
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            transition: transform .3s ease-in-out;
        }
        .navbar-brand {
            padding: .75rem 1rem;
            background-color: rgba(0, 0, 0, .25);
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
            width: var(--sidebar-width);
        }
        .main-content {
            margin-left: var(--sidebar-width);
            padding-top: 70px; 
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        .nav-link { 
            color: #333; 
            display: flex;
            align-items: center;
        }
        .nav-link.active, .nav-link:hover { color: #0d6efd; }
        .nav-link .bi { margin-right: 0.8rem; font-size: 1.1rem; }
        .page-section {
            display: none;
        }
        #dashboard {
            display: block; /* Garante que o dashboard apareça primeiro */
        }
        .navbar-toggler {
            z-index: 1001;
        }
        @media (max-width: 767.98px) {
            .sidebar {
                transform: translateX(calc(-1 * var(--sidebar-width)));
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding-top: 1rem;
            }
            .navbar-brand {
                width: auto;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark fixed-top p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="#">Matrix</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation" style="top: .5rem; right: 1rem;">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav ms-auto">
            <div class="nav-item text-nowrap">
                <button id="btn-logout" class="btn nav-link px-3" style="background: none; border: none;">
                    <i class="bi bi-box-arrow-right"></i> Sair
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link active" href="#" data-target="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-target="provedor"><i class="bi bi-hdd-stack-fill"></i> Provedor</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-target="clientes"><i class="bi bi-people-fill"></i> Clientes</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-target="planos"><i class="bi bi-file-earmark-spreadsheet-fill"></i> Planos</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-target="tickets"><i class="bi bi-ticket-detailed-fill"></i> Tickets</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-target="usuarios"><i class="bi bi-person-gear"></i> Usuários</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                
                <div id="dashboard" class="page-section">
                    <h1 class="h2 border-bottom pb-2 mb-3">Dashboard</h1>
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6"><div class="card text-center shadow-sm"><div class="card-body"><h5 class="card-title">Clientes Ativos</h5><p class="fs-2 fw-bold" id="total-clientes">--</p></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card text-center shadow-sm"><div class="card-body"><h5 class="card-title">Tickets Abertos</h5><p class="fs-2 fw-bold text-danger" id="total-tickets">--</p></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card text-center shadow-sm"><div class="card-body"><h5 class="card-title">OLTs Online</h5><p class="fs-2 fw-bold text-success" id="total-olts">--</p></div></div></div>
                        <div class="col-lg-3 col-md-6"><div class="card text-center shadow-sm"><div class="card-body"><h5 class="card-title">Planos Cadastrados</h5><p class="fs-2 fw-bold" id="total-planos">--</p></div></div></div>
                    </div>
                </div>

                <div id="provedor" class="page-section">
                    <div class="card shadow-sm mb-4"><div class="card-header"><h1 class="h2 mb-0">Ferramentas do Provedor</h1></div></div>
                    
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="h5 mb-0">Associar ONU (Autofind)</h2>
                            <button id="btn-atualizar-autofind" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Lista de ONUs
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-secondary">Busque as ONUs não provisionadas na OLT e depois associe a um cliente cadastrado.</div>
                            
                            <h5 class="mt-4">ONUs Encontradas</h5>
                            <div class="table-responsive mb-4" style="max-height: 300px;">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Selecionar</th>
                                            <th>MAC Address (SN)</th>
                                            <th>Porta PON</th>
                                            <th>OLT</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-autofind-corpo">
                                        <tr><td colspan="4" class="text-center">Clique em "Atualizar Lista de ONUs" para começar.</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h5 class="mt-4">Associar ONU Selecionada ao Cliente</h5>
                             <form id="form-associar-onu" class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label for="associar-cliente-id" class="form-label">Selecione o Cliente</label>
                                    <select id="associar-cliente-id" class="form-select" required>
                                        <option value="">Selecione um cliente...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="associar-onu-mac" class="form-label">ONU Selecionada (MAC/SN)</label>
                                    <input type="text" id="associar-onu-mac" class="form-control" readonly required>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-success"><i class="bi bi-link-45deg"></i> Associar ao Cliente</button>
                                </div>
                            </form>
                            <div id="mensagem-resposta-associacao" class="mt-3"></div>
                        </div>
                    </div>

                    <div class="card mb-4"><div class="card-header"><h2 class="h5 mb-0">Cadastro de OLTs</h2></div><div class="card-body"><form id="form-olt"><input type="hidden" id="olt-id"><div class="row"><div class="col-md-6 mb-3"><label for="olt-nome" class="form-label">Nome (Apelido)</label><input type="text" class="form-control" id="olt-nome" required></div><div class="col-md-6 mb-3"><label for="olt-ip" class="form-label">Endereço IP</label><input type="text" class="form-control" id="olt-ip" required></div></div><div class="row"><div class="col-md-4 mb-3"><label for="olt-marca" class="form-label">Marca</label><input type="text" class="form-control" id="olt-marca"></div><div class="col-md-4 mb-3"><label for="olt-usuario" class="form-label">Usuário</label><input type="text" class="form-control" id="olt-usuario" required></div><div class="col-md-4 mb-3"><label for="olt-senha" class="form-label">Senha</label><input type="password" class="form-control" id="olt-senha"><div class="form-text">Deixe em branco para não alterar.</div></div></div><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar OLT</button><button type="button" id="btn-cancelar-edicao-olt" class="btn btn-secondary d-none">Cancelar Edição</button></form><div id="mensagem-resposta-olt" class="mt-3"></div></div></div>
                    <div class="card"><div class="card-header"><h2 class="h5 mb-0">OLTs Cadastradas</h2></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Nome</th><th>IP</th><th>Marca</th><th>Usuário</th><th>Ações</th></tr></thead><tbody id="tabela-olts-corpo"></tbody></table></div></div></div>
                </div>

                <div id="clientes" class="page-section">
                    <div class="card shadow-sm mb-4"><div class="card-header"><h1 class="h2 mb-0">Gestão de Clientes</h1></div></div>
                    <div class="card mb-4"><div class="card-header"><h2 class="h5 mb-0">Adicionar/Editar Cliente</h2></div><div class="card-body"><form id="form-cliente"><input type="hidden" id="cliente-id"><div class="row"><div class="col-md-8 mb-3"><label for="nome" class="form-label">Nome Completo:</label><input type="text" class="form-control" id="nome" name="nome" required></div><div class="col-md-4 mb-3"><label for="cliente-plano-id" class="form-label">Plano:</label><select id="cliente-plano-id" class="form-select" required><option value="">Selecione um plano...</option></select></div></div><div class="row"><div class="col-md-6 mb-3"><label for="cnpj_cpf" class="form-label">CPF/CNPJ:</label><input type="text" class="form-control" id="cnpj_cpf" required></div><div class="col-md-6 mb-3"><label for="rg" class="form-label">RG:</label><input type="text" class="form-control" id="rg"></div></div><div class="row"><div class="col-md-8 mb-3"><label for="endereco" class="form-label">Endereço:</label><input type="text" class="form-control" id="endereco"></div><div class="col-md-4 mb-3"><label for="bairro" class="form-label">Bairro:</label><input type="text" class="form-control" id="bairro"></div></div><div class="row"><div class="col-md-4 mb-3"><label for="numero" class="form-label">Número:</label><input type="text" class="form-control" id="numero"></div><div class="col-md-8 mb-3"><label for="complemento" class="form-label">Complemento:</label><input type="text" class="form-control" id="complemento"></div></div><div class="row"><div class="col-md-6 mb-3"><label for="login" class="form-label">Login PPPoE:</label><input type="text" class="form-control" id="login" required></div><div class="col-md-6 mb-3"><label for="senha" class="form-label">Senha PPPoE:</label><div class="input-group"><input type="password" class="form-control" id="senha" required><button class="btn btn-outline-secondary" type="button" id="btn-ver-senha"><i class="bi bi-eye"></i></button></div></div></div><button type="submit" class="btn btn-primary"><i class="bi bi-person-plus-fill"></i> Salvar Cliente</button></form><div id="mensagem-resposta-cliente" class="mt-3"></div></div></div>
                    <div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h2 class="h5 mb-0">Clientes Cadastrados</h2><button id="btn-atualizar-clientes" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Atualizar Lista</button></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Nome Completo</th><th>CPF/CNPJ</th><th>Login PPPoE</th><th>Plano</th><th>Status</th><th>Ações</th></tr></thead><tbody id="tabela-clientes-corpo"></tbody></table></div></div></div>
                </div>

                <div id="planos" class="page-section">
                    <div class="card shadow-sm mb-4"><div class="card-header"><h1 class="h2 mb-0">Gestão de Planos</h1></div></div>
                    <div class="card mb-4"><div class="card-header"><h2 class="h5 mb-0">Adicionar/Editar Plano</h2></div><div class="card-body"><form id="form-plano"><input type="hidden" id="plano-id"><div class="mb-3"><label for="plano-nome" class="form-label">Nome do Plano</label><input type="text" class="form-control" id="plano-nome" required></div><div class="row"><div class="col-md-3"><label for="plano-download" class="form-label">Download (Mbps)</label><input type="number" class="form-control" id="plano-download" required></div><div class="col-md-3"><label for="plano-upload" class="form-label">Upload (Mbps)</label><input type="number" class="form-control" id="plano-upload" required></div><div class="col-md-3"><label for="plano-preco" class="form-label">Preço (R$)</label><input type="number" step="0.01" class="form-control" id="plano-preco" required></div><div class="col-md-3"><label for="plano-profile" class="form-label">Profile MikroTik</label><input type="text" class="form-control" id="plano-profile" required></div></div><button type="submit" class="btn btn-primary mt-3"><i class="bi bi-save"></i> Salvar Plano</button><button type="button" id="btn-cancelar-edicao-plano" class="btn btn-secondary mt-3 d-none">Cancelar Edição</button></form><div id="mensagem-resposta-plano" class="mt-3"></div></div></div>
                    <div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h2 class="h5 mb-0">Planos Existentes</h2><button id="btn-atualizar-planos" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Nome</th><th>Download</th><th>Upload</th><th>Preço</th><th>Profile MikroTik</th><th>Ações</th></tr></thead><tbody id="tabela-planos-corpo"></tbody></table></div></div></div>
                </div>

                <div id="tickets" class="page-section">
                    <div class="card shadow-sm mb-4"><div class="card-header"><h1 class="h2 mb-0">Sistema de Tickets</h1></div></div>
                    <div class="card mb-4"><div class="card-header"><h2 class="h5 mb-0">Abrir Novo Ticket</h2></div><div class="card-body"><form id="form-ticket"><div class="mb-3"><label for="ticket-cliente-id" class="form-label">Cliente:</label><select id="ticket-cliente-id" class="form-select" required><option value="">Selecione um cliente...</option></select></div><div class="mb-3"><label for="ticket-assunto" class="form-label">Assunto:</label><input type="text" class="form-control" id="ticket-assunto" required></div><div class="mb-3"><label for="ticket-mensagem" class="form-label">Mensagem:</label><textarea id="ticket-mensagem" class="form-control" rows="4"></textarea></div><button type="submit" class="btn btn-success"><i class="bi bi-send"></i> Abrir Ticket</button></form><div id="mensagem-resposta-ticket" class="mt-3"></div></div></div>
                    <div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h2 class="h5 mb-0">Tickets Abertos</h2><button id="btn-atualizar-tickets" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Cliente</th><th>Assunto</th><th>Data Abertura</th><th>Status</th><th>Ações</th></tr></thead><tbody id="tabela-tickets-corpo"></tbody></table></div></div></div>
                </div>

                <div id="usuarios" class="page-section">
                    <div class="card shadow-sm mb-4"><div class="card-header"><h1 class="h2 mb-0">Gestão de Usuários</h1></div></div>
                    <div class="card mb-4"><div class="card-header"><h2 class="h5 mb-0">Adicionar/Editar Usuário</h2></div><div class="card-body"><form id="form-usuario"><input type="hidden" id="usuario-id"><div class="row"><div class="col-md-6 mb-3"><label for="usuario-nome" class="form-label">Nome</label><input type="text" class="form-control" id="usuario-nome" required></div><div class="col-md-6 mb-3"><label for="usuario-email" class="form-label">E-mail</label><input type="email" class="form-control" id="usuario-email" required></div></div><div class="mb-3"><label for="usuario-senha" class="form-label">Senha</label><input type="password" class="form-control" id="usuario-senha"><div class="form-text">Deixe em branco para não alterar a senha existente.</div></div><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar Usuário</button><button type="button" id="btn-cancelar-edicao-usuario" class="btn btn-secondary d-none">Cancelar Edição</button></form><div id="mensagem-resposta-usuario" class="mt-3"></div></div></div>
                    <div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h2 class="h5 mb-0">Usuários do Sistema</h2><button id="btn-novo-usuario" class="btn btn-sm btn-success"><i class="bi bi-plus-circle"></i> Adicionar Novo</button></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Nome</th><th>E-mail</th><th>Ações</th></tr></thead><tbody id="tabela-usuarios-corpo"></tbody></table></div></div></div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>

    // Versão 100% completa e funcional do JavaScript
    document.addEventListener('DOMContentLoaded', function () {
    
        if (!localStorage.getItem('usuario_logado')) {
            window.location.href = '/';
            return;
        }
    
        const API_BASE_URL = '/api';
    
        // --- NAVEGAÇÃO ---
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        const pageSections = document.querySelectorAll('.page-section');
        function showSection(targetId) {
            pageSections.forEach(s => s.style.display = 'none');
            navLinks.forEach(l => l.classList.remove('active'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) { targetSection.style.display = 'block'; }
            const activeLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
            if (activeLink) { activeLink.classList.add('active'); }
        }
        navLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                showSection(this.getAttribute('data-target'));
            });
        });
    
        // --- LOGOUT ---
        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem('usuario_logado');
            window.location.href = '/';
        });

        // --- FUNÇÕES DE LÓGICA E CARREGAMENTO ---

        // OLTs
        function prepararEdicaoOLT(olt) {
            document.getElementById('olt-id').value = olt.id;
            document.getElementById('olt-nome').value = olt.nome;
            document.getElementById('olt-ip').value = olt.ip_address;
            document.getElementById('olt-marca').value = olt.marca || '';
            document.getElementById('olt-usuario').value = olt.usuario;
            document.querySelector("#form-olt button[type='submit']").textContent = 'Atualizar OLT';
            document.getElementById('btn-cancelar-edicao-olt').classList.remove('d-none');
            document.getElementById('olt-senha').required = false;
        }
        function resetarFormularioOLT() {
            document.getElementById('form-olt').reset();
            document.getElementById('olt-id').value = '';
            document.querySelector("#form-olt button[type='submit']").textContent = 'Salvar OLT';
            document.getElementById('btn-cancelar-edicao-olt').classList.add('d-none');
            document.getElementById('olt-senha').required = true;
        }
        async function carregarOLTs() {
            const tabelaCorpo = document.getElementById('tabela-olts-corpo');
            if (!tabelaCorpo) return;
            tabelaCorpo.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
                const resposta = await fetch(`${API_BASE_URL}/olts`);
                const olts = await resposta.json();
                tabelaCorpo.innerHTML = '';
                olts.forEach(olt => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${olt.id}</td><td>${olt.nome}</td><td>${olt.ip_address}</td><td>${olt.marca || ''}</td><td>${olt.usuario}</td><td><button class="btn btn-sm btn-warning btn-editar-olt" data-id="${olt.id}">Editar</button> <button class="btn btn-sm btn-danger btn-excluir-olt" data-id="${olt.id}">Excluir</button></td>`;
                    tabelaCorpo.appendChild(tr);
                });
            } catch (error) {
                tabelaCorpo.innerHTML = '<tr><td colspan="6" class="text-danger">Erro ao carregar OLTs.</td></tr>';
            }
        }

        // Planos
        async function carregarPlanos(popularDropdown = false) {
            const tabelaCorpo = document.getElementById('tabela-planos-corpo');
            if (tabelaCorpo) {
                tabelaCorpo.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
                try {
                    const resposta = await fetch(`${API_BASE_URL}/planos`);
                    const planos = await resposta.json();
                    tabelaCorpo.innerHTML = '';
                    planos.forEach(plano => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${plano.id}</td><td>${plano.nome_plano}</td><td>${plano.velocidade_download}</td><td>${plano.velocidade_upload}</td><td>R$ ${Number(plano.preco).toFixed(2)}</td><td>${plano.mikrotik_profile_name}</td><td><button class="btn btn-sm btn-warning btn-editar-plano" data-id="${plano.id}">Editar</button> <button class="btn btn-sm btn-danger btn-excluir-plano" data-id="${plano.id}">Excluir</button></td>`;
                        tabelaCorpo.appendChild(tr);
                    });
                } catch (error) {
                    tabelaCorpo.innerHTML = '<tr><td colspan="7" class="text-danger">Erro ao carregar planos.</td></tr>';
                }
            }
            if(popularDropdown) {
                const dropdownPlanos = document.getElementById('cliente-plano-id');
                if(!dropdownPlanos) return;
                try {
                    const resposta = await fetch(`${API_BASE_URL}/planos`);
                    const planos = await resposta.json();
                    dropdownPlanos.innerHTML = '<option value="">Selecione um plano...</option>';
                    planos.forEach(plano => {
                        const option = document.createElement('option');
                        option.value = plano.id;
                        option.textContent = plano.nome_plano;
                        dropdownPlanos.appendChild(option);
                    });
                } catch (error) { console.error("Erro ao popular dropdown de planos:", error); }
            }
        }

        // Usuários
        async function carregarUsuarios() {
            const tabelaCorpo = document.getElementById('tabela-usuarios-corpo');
            if (!tabelaCorpo) return;
            tabelaCorpo.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            try {
                const resposta = await fetch(`${API_BASE_URL}/usuarios`);
                const usuarios = await resposta.json();
                tabelaCorpo.innerHTML = '';
                usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${usuario.id}</td><td>${usuario.nome}</td><td>${usuario.email}</td><td><button class="btn btn-sm btn-warning btn-editar-usuario" data-id="${usuario.id}">Editar</button> <button class="btn btn-sm btn-danger btn-excluir-usuario" data-id="${usuario.id}">Excluir</button></td>`;
                    tabelaCorpo.appendChild(tr);
                });
            } catch (error) {
                tabelaCorpo.innerHTML = '<tr><td colspan="4" class="text-danger">Erro ao carregar usuários.</td></tr>';
            }
        }

        // Tickets
        async function carregarTickets() {
            const tabelaCorpo = document.getElementById('tabela-tickets-corpo');
            if(!tabelaCorpo) return;
            tabelaCorpo.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
                const resposta = await fetch(`${API_BASE_URL}/tickets`);
                const tickets = await resposta.json();
                tabelaCorpo.innerHTML = '';
                tickets.forEach(ticket => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${ticket.id}</td><td>${ticket.cliente_nome}</td><td>${ticket.assunto}</td><td>${new Date(ticket.data_abertura).toLocaleString('pt-BR')}</td><td>${ticket.status}</td><td>${ticket.status === 'aberto' ? `<button class="btn btn-sm btn-info btn-fechar-ticket" data-id="${ticket.id}">Fechar</button>` : 'Fechado'}</td>`;
                    tabelaCorpo.appendChild(tr);
                });
            } catch (error) {
                tabelaCorpo.innerHTML = '<tr><td colspan="6" class="text-danger">Erro ao carregar tickets.</td></tr>';
            }
        }
    
        // Clientes
        async function carregarClientes(popularDropdowns = false) {
            const tabelaCorpo = document.getElementById('tabela-clientes-corpo');
            if (tabelaCorpo) {
                tabelaCorpo.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
                try {
                    const resposta = await fetch(`${API_BASE_URL}/clientes`);
                    if (!resposta.ok) throw new Error('Falha na API de clientes');
                    const clientes = await resposta.json();
                    tabelaCorpo.innerHTML = '';
                    clientes.forEach(cliente => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${cliente.id}</td><td>${cliente.nome_completo}</td><td>${cliente.cnpj_cpf}</td><td>${cliente.login_pppoe}</td><td>${cliente.nome_plano || 'N/A'}</td><td>${cliente.status}</td><td><button class="btn btn-sm btn-warning btn-editar-cliente" data-id="${cliente.id}">Editar</button> <button class="btn btn-sm btn-danger btn-excluir-cliente" data-id="${cliente.id}">Excluir</button></td>`;
                        tabelaCorpo.appendChild(tr);
                    });
                } catch (error) {
                    console.error('Erro detalhado ao carregar clientes:', error);
                    tabelaCorpo.innerHTML = '<tr><td colspan="7" class="text-danger">Erro ao carregar clientes. Verifique o console.</td></tr>';
                }
            }
            if (popularDropdowns) {
                const dropdowns = [document.getElementById('ticket-cliente-id'), document.getElementById('associar-cliente-id')];
                try {
                    const resposta = await fetch(`${API_BASE_URL}/clientes`);
                    if (!resposta.ok) throw new Error('Falha na API de clientes para dropdowns');
                    const clientes = await resposta.json();
                    dropdowns.forEach(dropdown => {
                        if(dropdown) {
                            dropdown.innerHTML = '<option value="">Selecione um cliente...</option>';
                            clientes.forEach(cliente => {
                                const option = document.createElement('option');
                                option.value = cliente.id;
                                option.textContent = `${cliente.id} - ${cliente.nome_completo}`;
                                dropdown.appendChild(option);
                            });
                        }
                    });
                } catch (error) { console.error("Erro ao popular dropdowns de clientes:", error); }
            }
        }
        
        async function prepararEdicaoCliente(id) {
            try {
                const resposta = await fetch(`${API_BASE_URL}/clientes/${id}`);
                if (!resposta.ok) throw new Error('Cliente nao encontrado na API');
                const cliente = await resposta.json();
                document.getElementById('cliente-id').value = cliente.id;
                document.getElementById('nome').value = cliente.nome_completo;
                document.getElementById('cnpj_cpf').value = cliente.cnpj_cpf;
                document.getElementById('rg').value = cliente.rg;
                document.getElementById('endereco').value = cliente.endereco;
                document.getElementById('bairro').value = cliente.bairro;
                document.getElementById('numero').value = cliente.numero;
                document.getElementById('complemento').value = cliente.complemento;
                document.getElementById('login').value = cliente.login_pppoe;
                document.getElementById('senha').value = cliente.senha_pppoe;
                document.getElementById('cliente-plano-id').value = cliente.plano_id;
                document.querySelector("#form-cliente button[type=submit]").textContent = 'Salvar Alterações';
            } catch (error) { 
                console.error("Erro em prepararEdicaoCliente:", error);
                alert('Erro ao buscar dados do cliente para edição.'); 
            }
        }
        function resetarFormularioCliente() {
            document.getElementById('form-cliente').reset();
            document.getElementById('cliente-id').value = '';
            document.querySelector("#form-cliente button[type=submit]").textContent = 'Salvar Cliente';
        }

        // --- EVENT LISTENERS (COMPLETOS) ---
        
        // Clientes
        const formCliente = document.getElementById('form-cliente');
        if (formCliente) {
            formCliente.addEventListener('submit', async (event) => {
                event.preventDefault();
                const id = document.getElementById('cliente-id').value;
                const url = id ? `${API_BASE_URL}/clientes/${id}` : `${API_BASE_URL}/clientes`;
                const method = id ? 'PUT' : 'POST';
                const dadosCliente = { 
                    nome_completo: document.getElementById('nome').value, 
                    cnpj_cpf: document.getElementById('cnpj_cpf').value,
                    rg: document.getElementById('rg').value,
                    endereco: document.getElementById('endereco').value,
                    bairro: document.getElementById('bairro').value,
                    numero: document.getElementById('numero').value,
                    complemento: document.getElementById('complemento').value,
                    login_pppoe: document.getElementById('login').value, 
                    senha_pppoe: document.getElementById('senha').value, 
                    plano_id: document.getElementById('cliente-plano-id').value 
                };
                try {
                    const resposta = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosCliente) });
                    const resultado = await resposta.json();
                    const divRespostaCliente = document.getElementById('mensagem-resposta-cliente');
                    if (resposta.ok) {
                        divRespostaCliente.innerHTML = `<p class="text-success">${resultado.mensagem}</p>`;
                        resetarFormularioCliente();
                        carregarClientes(true);
                    } else { divRespostaCliente.innerHTML = `<p class="text-danger">Erro: ${resultado.erro}</p>`; }
                } catch (error) { document.getElementById('mensagem-resposta-cliente').innerHTML = `<p class="text-danger">Não foi possível conectar à API.</p>`; }
            });

            document.getElementById('tabela-clientes-corpo').addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('btn-editar-cliente')) {
                    prepararEdicaoCliente(target.dataset.id);
                }
                // Adicionar lógica para o botão de excluir cliente
            });
        }

        // --- LÓGICA AUTOFIND ---
        const btnAtualizarAutofind = document.getElementById('btn-atualizar-autofind');
        if (btnAtualizarAutofind) {
            btnAtualizarAutofind.addEventListener('click', async () => {
                const tabelaCorpo = document.getElementById('tabela-autofind-corpo');
                tabelaCorpo.innerHTML = '<tr><td colspan="4" class="text-center">Buscando...</td></tr>';
                
                // Simulação. Substitua pela sua chamada de API real.
                setTimeout(() => {
                    const onusExemplo = [
                        { mac: 'ZTEGC8FDAAF6', pon: '0/1/1', olt_nome: 'Alto da Serra' },
                        { mac: 'HWTCAB123456', pon: '0/1/2', olt_nome: 'Alto da Serra' },
                    ];
                    tabelaCorpo.innerHTML = '';
                    onusExemplo.forEach(onu => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><input class="form-check-input" type="radio" name="onuSelecionada" value="${onu.mac}"></td><td>${onu.mac}</td><td>${onu.pon}</td><td>${onu.olt_nome}</td>`;
                        tabelaCorpo.appendChild(tr);
                    });
                }, 1000);
            });
        }
        document.getElementById('tabela-autofind-corpo').addEventListener('change', (event) => {
            if (event.target.name === 'onuSelecionada') {
                document.getElementById('associar-onu-mac').value = event.target.value;
            }
        });
        document.getElementById('form-associar-onu').addEventListener('submit', (event) => {
            event.preventDefault();
            // Lógica de associação aqui
        });
        
        // --- CARGA INICIAL ---
        function cargaInicial() {
            carregarClientes(true);
            carregarOLTs();
            carregarPlanos(true);
            carregarTickets();
            carregarUsuarios();
        }
        
        cargaInicial();
    });
    </script>
</body>
</html>
